clearvars;
close all;

% Тестовый расчёт тестового спектра
Lambda_init = [360	380	400	420	440	460	480	500	520	540	560	580	600	620	640	660	680	700	720	740	760	780	800	820];
Lambda = [375	375.500000000000	376	376.500000000000	377	377.500000000000	378	378.500000000000	379	379.500000000000	380	380.500000000000	381	381.500000000000	382	382.500000000000	383	383.500000000000	384	384.500000000000	385	385.500000000000	386	386.500000000000	387	387.500000000000	388	388.500000000000	389	389.500000000000	390	390.500000000000	391	391.500000000000	392	392.500000000000	393	393.500000000000	394	394.500000000000	395	395.500000000000	396	396.500000000000	397	397.500000000000	398	398.500000000000	399	399.500000000000	400	400.500000000000	401	401.500000000000	402	402.500000000000	403	403.500000000000	404	404.500000000000	405	405.500000000000	406	406.500000000000	407	407.500000000000	408	408.500000000000	409	409.500000000000	410	410.500000000000	411	411.500000000000	412	412.500000000000	413	413.500000000000	414	414.500000000000	415	415.500000000000	416	416.500000000000	417	417.500000000000	418	418.500000000000	419	419.500000000000	420	420.500000000000	421	421.500000000000	422	422.500000000000	423	423.500000000000	424	424.500000000000	425	425.500000000000	426	426.500000000000	427	427.500000000000	428	428.500000000000	429	429.500000000000	430	430.500000000000	431	431.500000000000	432	432.500000000000	433	433.500000000000	434	434.500000000000	435	435.500000000000	436	436.500000000000	437	437.500000000000	438	438.500000000000	439	439.500000000000	440	440.500000000000	441	441.500000000000	442	442.500000000000	443	443.500000000000	444	444.500000000000	445	445.500000000000	446	446.500000000000	447	447.500000000000	448	448.500000000000	449	449.500000000000	450	450.500000000000	451	451.500000000000	452	452.500000000000	453	453.500000000000	454	454.500000000000	455	455.500000000000	456	456.500000000000	457	457.500000000000	458	458.500000000000	459	459.500000000000	460	460.500000000000	461	461.500000000000	462	462.500000000000	463	463.500000000000	464	464.500000000000	465	465.500000000000	466	466.500000000000	467	467.500000000000	468	468.500000000000	469	469.500000000000	470	470.500000000000	471	471.500000000000	472	472.500000000000	473	473.500000000000	474	474.500000000000	475	475.500000000000	476	476.500000000000	477	477.500000000000	478	478.500000000000	479	479.500000000000	480	480.500000000000	481	481.500000000000	482	482.500000000000	483	483.500000000000	484	484.500000000000	485	485.500000000000	486	486.500000000000	487	487.500000000000	488	488.500000000000	489	489.500000000000	490	490.500000000000	491	491.500000000000	492	492.500000000000	493	493.500000000000	494	494.500000000000	495	495.500000000000	496	496.500000000000	497	497.500000000000	498	498.500000000000	499	499.500000000000	500	500.500000000000	501	501.500000000000	502	502.500000000000	503	503.500000000000	504	504.500000000000	505	505.500000000000	506	506.500000000000	507	507.500000000000	508	508.500000000000	509	509.500000000000	510	510.500000000000	511	511.500000000000	512	512.500000000000	513	513.500000000000	514	514.500000000000	515	515.500000000000	516	516.500000000000	517	517.500000000000	518	518.500000000000	519	519.500000000000	520	520.500000000000	521	521.500000000000	522	522.500000000000	523	523.500000000000	524	524.500000000000	525	525.500000000000	526	526.500000000000	527	527.500000000000	528	528.500000000000	529	529.500000000000	530	530.500000000000	531	531.500000000000	532	532.500000000000	533	533.500000000000	534	534.500000000000	535	535.500000000000	536	536.500000000000	537	537.500000000000	538	538.500000000000	539	539.500000000000	540	540.500000000000	541	541.500000000000	542	542.500000000000	543	543.500000000000	544	544.500000000000	545	545.500000000000	546	546.500000000000	547	547.500000000000	548	548.500000000000	549	549.500000000000	550	550.500000000000	551	551.500000000000	552	552.500000000000	553	553.500000000000	554	554.500000000000	555	555.500000000000	556	556.500000000000	557	557.500000000000	558	558.500000000000	559	559.500000000000	560	560.500000000000	561	561.500000000000	562	562.500000000000	563	563.500000000000	564	564.500000000000	565	565.500000000000	566	566.500000000000	567	567.500000000000	568	568.500000000000	569	569.500000000000	570	570.500000000000	571	571.500000000000	572	572.500000000000	573	573.500000000000	574	574.500000000000	575	575.500000000000	576	576.500000000000	577	577.500000000000	578	578.500000000000	579	579.500000000000	580	580.500000000000	581	581.500000000000	582	582.500000000000	583	583.500000000000	584	584.500000000000	585	585.500000000000	586	586.500000000000	587	587.500000000000	588	588.500000000000	589	589.500000000000	590	590.500000000000	591	591.500000000000	592	592.500000000000	593	593.500000000000	594	594.500000000000	595	595.500000000000	596	596.500000000000	597	597.500000000000	598	598.500000000000	599	599.500000000000	600	600.500000000000	601	601.500000000000	602	602.500000000000	603	603.500000000000	604	604.500000000000	605	605.500000000000	606	606.500000000000	607	607.500000000000	608	608.500000000000	609	609.500000000000	610	610.500000000000	611	611.500000000000	612	612.500000000000	613	613.500000000000	614	614.500000000000	615	615.500000000000	616	616.500000000000	617	617.500000000000	618	618.500000000000	619	619.500000000000	620	620.500000000000	621	621.500000000000	622	622.500000000000	623	623.500000000000	624	624.500000000000	625	625.500000000000	626	626.500000000000	627	627.500000000000	628	628.500000000000	629	629.500000000000	630	630.500000000000	631	631.500000000000	632	632.500000000000	633	633.500000000000	634	634.500000000000	635	635.500000000000	636	636.500000000000	637	637.500000000000	638	638.500000000000	639	639.500000000000	640	640.500000000000	641	641.500000000000	642	642.500000000000	643	643.500000000000	644	644.500000000000	645	645.500000000000	646	646.500000000000	647	647.500000000000	648	648.500000000000	649	649.500000000000	650	650.500000000000	651	651.500000000000	652	652.500000000000	653	653.500000000000	654	654.500000000000	655	655.500000000000	656	656.500000000000	657	657.500000000000	658	658.500000000000	659	659.500000000000	660	660.500000000000	661	661.500000000000	662	662.500000000000	663	663.500000000000	664	664.500000000000	665	665.500000000000	666	666.500000000000	667	667.500000000000	668	668.500000000000	669	669.500000000000	670	670.500000000000	671	671.500000000000	672	672.500000000000	673	673.500000000000	674	674.500000000000	675	675.500000000000	676	676.500000000000	677	677.500000000000	678	678.500000000000	679	679.500000000000	680	680.500000000000	681	681.500000000000	682	682.500000000000	683	683.500000000000	684	684.500000000000	685	685.500000000000	686	686.500000000000	687	687.500000000000	688	688.500000000000	689	689.500000000000	690	690.500000000000	691	691.500000000000	692	692.500000000000	693	693.500000000000	694	694.500000000000	695	695.500000000000	696	696.500000000000	697	697.500000000000	698	698.500000000000	699	699.500000000000	700	700.500000000000	701	701.500000000000	702	702.500000000000	703	703.500000000000	704	704.500000000000	705	705.500000000000	706	706.500000000000	707	707.500000000000	708	708.500000000000	709	709.500000000000	710	710.500000000000	711	711.500000000000	712	712.500000000000	713	713.500000000000	714	714.500000000000	715	715.500000000000	716	716.500000000000	717	717.500000000000	718	718.500000000000	719	719.500000000000	720	720.500000000000	721	721.500000000000	722	722.500000000000	723	723.500000000000	724	724.500000000000	725	725.500000000000	726	726.500000000000	727	727.500000000000	728	728.500000000000	729	729.500000000000	730	730.500000000000	731	731.500000000000	732	732.500000000000	733	733.500000000000	734	734.500000000000	735	735.500000000000	736	736.500000000000	737	737.500000000000	738	738.500000000000	739	739.500000000000	740	740.500000000000	741	741.500000000000	742	742.500000000000	743	743.500000000000	744	744.500000000000	745	745.500000000000	746	746.500000000000	747	747.500000000000	748	748.500000000000	749	749.500000000000	750	750.500000000000	751	751.500000000000	752	752.500000000000	753	753.500000000000	754	754.500000000000	755	755.500000000000	756	756.500000000000	757	757.500000000000	758	758.500000000000	759	759.500000000000	760	760.500000000000	761	761.500000000000	762	762.500000000000	763	763.500000000000	764	764.500000000000	765	765.500000000000	766	766.500000000000	767	767.500000000000	768	768.500000000000	769	769.500000000000	770	770.500000000000	771	771.500000000000	772	772.500000000000	773	773.500000000000	774	774.500000000000	775	775.500000000000	776	776.500000000000	777	777.500000000000	778	778.500000000000	779	779.500000000000	780	780.500000000000	781	781.500000000000	782	782.500000000000	783	783.500000000000	784	784.500000000000	785	785.500000000000	786	786.500000000000	787	787.500000000000	788	788.500000000000	789	789.500000000000	790	790.500000000000	791	791.500000000000	792	792.500000000000	793	793.500000000000	794	794.500000000000	795	795.500000000000	796	796.500000000000	797	797.500000000000	798	798.500000000000	799	799.500000000000	800];
I = [0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	2.55271420787153e-12	1.14264350257311e-11	2.05370597385133e-11	3.04389051416134e-11	5.15500077384293e-05	0.000207094627662979	0.000362639247587528	0.000518183867512078	0.000673728487436627	0.000829273107118061	0.000984817726408774	0.00127175860404223	0.00160543320242631	0.00200482983445232	0.00252716980530581	0.00304950977615931	0.00357184974701280	0.00409418971786629	0.00461652968871978	0.00513886966007687	0.00589243549419970	0.00679249224750792	0.00768520957074316	0.00856517419506994	0.00944513881963602	0.0103251034442021	0.0112050680687682	0.0120874391787212	0.0132838566424308	0.0144802741074666	0.0156766915725023	0.0169479324296652	0.0183401072246061	0.0197322820195761	0.0211959704130713	0.0230255423390160	0.0248551142757397	0.0266846862124633	0.0285142581491870	0.0303438300859107	0.0324679434684349	0.0360851174380367	0.0397022914116055	0.0433194653918751	0.0469366393712672	0.0505538133504287	0.0541709873295901	0.0578489584769694	0.0615271616746091	0.0653876672419826	0.0695039939875635	0.0738774433489278	0.0786803591820889	0.0834832750152500	0.0882861908484112	0.0930891066799304	0.0978920225112803	0.102694938342630	0.108301046718210	0.114999980072435	0.121765155371465	0.128530330734887	0.135295506112654	0.142207748269436	0.150150771619053	0.158093794967772	0.166036818316492	0.175655883891003	0.187694017237637	0.199732150588887	0.211770283940136	0.224879957361306	0.238671706131241	0.252879567958829	0.268246136443151	0.283717504368662	0.300141917327161	0.317930837952670	0.335841682854482	0.354727125770647	0.373853155486736	0.389870278472001	0.407417124601713	0.424974104500343	0.447996394492051	0.473052076430329	0.498107758352625	0.524042594779436	0.550241676382932	0.576958505414882	0.604231156392619	0.631885531892579	0.660750558999628	0.689615585900676	0.729818620061220	0.772038165366836	0.818500200004237	0.868584070384138	0.909702083283930	0.958078787861717	1.00057738077987	1.04042194731470	1.07005965266120	1.09407757690052	1.11815236651611	1.14194917258591	1.19554540702660	1.22671910214601	1.28407071157461	1.33274958560251	1.36353022303900	1.38802877159206	1.40429311821409	1.41327309517732	1.42229537338590	1.43132266274118	1.43150381456402	1.43009832972174	1.42789188712117	1.42742386998096	1.42360789701782	1.41288175051952	1.40363930145558	1.36565147714220	1.34706262165075	1.32723346344338	1.30818546188521	1.28699131712107	1.26667351622057	1.24822615248653	1.24330679861741	1.23109726431237	1.21706119884332	1.21372819572468	1.20389728260981	1.19799792974450	1.20294392392316	1.20595133005621	1.20301100809391	1.21196383160632	1.21555343131485	1.22628483717695	1.23100906672243	1.24439770548232	1.24951481267526	1.25671386723439	1.26669444692313	1.27473330776351	1.27822287167284	1.28158385760398	1.28087779329073	1.27790297907023	1.27903284837443	1.27559592010033	1.27857024341855	1.27215986065973	1.26223056098112	1.24930471225008	1.23619031343204	1.22592751836514	1.21553143187173	1.20651879670061	1.19563274989361	1.18930490775334	1.18026893598602	1.17291443931418	1.16390884858104	1.15671987142558	1.15030131221386	1.14368546847646	1.13621629727089	1.13281286998540	1.12985530584076	1.12665186081202	1.12399701382396	1.12161960166019	1.11869912371288	1.11600943757179	1.11685342051311	1.11762872387947	1.11873755372464	1.11961597254162	1.11991349426723	1.12111423811344	1.12328528031300	1.12456467276165	1.12488737616653	1.12585387312755	1.12847040929524	1.13161895151741	1.13499951697097	1.13717091823467	1.14108540035792	1.14672990602871	1.15278520644042	1.15945465171803	1.16651721992548	1.17252075370445	1.17838802037028	1.18805953158280	1.19737725383887	1.20633951944241	1.21527011786888	1.22459723554693	1.23360255225682	1.24288814751370	1.25271188524757	1.26242282564236	1.27138464965257	1.27942073421540	1.28731409647452	1.29254093879793	1.29729695061497	1.30211002941107	1.30613047738906	1.31023894991048	1.31251747114241	1.31463193700236	1.31552788496257	1.31484520987983	1.31371587479297	1.31249243731731	1.31122415553580	1.30989151225412	1.30856178739739	1.30671978925702	1.30448870663208	1.30174017793793	1.29876738896878	1.29541188936552	1.29235154909309	1.29009545605754	1.28826215445345	1.28701465252093	1.28607369514156	1.28407196675315	1.28135402727086	1.27941872790060	1.27755650056506	1.27595037063233	1.27485537394747	1.27404858882302	1.27330511339277	1.27263046555528	1.27216397887494	1.27198481901330	1.27172894415107	1.27090391486130	1.27008660375576	1.26947532864378	1.26889947639252	1.26877336953225	1.26864726266585	1.26851746619990	1.26820837590000	1.26795783716103	1.26812788071984	1.26829967792604	1.26850102965155	1.26879323303817	1.26934603849870	1.26977969390482	1.27017955010468	1.27060038615655	1.27116149841184	1.27180673396679	1.27245792379919	1.27321582671038	1.27399698611619	1.27490744456186	1.27579170886765	1.27667597317003	1.27737730079664	1.27768738634644	1.27799747190038	1.27832834599606	1.27879172884457	1.27925511170637	1.27962301687053	1.28010598286693	1.28075368068038	1.28140137849511	1.28205081768379	1.28272346568705	1.28348382904584	1.28460388651380	1.28610862123723	1.28770551677817	1.28932631751900	1.29094711825731	1.29265730761446	1.29441569384381	1.29617408008705	1.29789083779597	1.29931752834074	1.30038806005999	1.30144008526200	1.30251369153803	1.30358958516967	1.30466547880108	1.30574137244638	1.30678399055843	1.30778469731544	1.30864480854000	1.30922675784369	1.30978196012912	1.31033176811074	1.31088157607848	1.31147221174506	1.31207004921262	1.31266788667842	1.31324620438694	1.31370487221539	1.31403406921316	1.31447958054529	1.31501867795006	1.31555892618806	1.31609917444350	1.31668512804571	1.31727802019975	1.31788655919430	1.31815568140589	1.31808761761470	1.31801955383034	1.31795149005103	1.31782852674443	1.31770469257715	1.31765121753851	1.31759774250726	1.31762621935566	1.31769728344504	1.31773131762062	1.31774713848801	1.31774598401293	1.31768957542239	1.31763838924522	1.31760869535272	1.31757900147079	1.31716995446269	1.31598695354245	1.31485861339833	1.31374658363562	1.31263688707043	1.31152719050190	1.31041749392562	1.30931858738645	1.30822823931454	1.30686986772959	1.30543144969061	1.30399303165202	1.30264605729600	1.30132559113989	1.30002407656874	1.29872700967248	1.29744698382551	1.29703771785824	1.29663553034702	1.29623334283713	1.29583757765880	1.29567600908296	1.29553131844390	1.29541029261762	1.29529130997639	1.29517059532381	1.29484507448723	1.29451382923230	1.29419240180874	1.29406981452845	1.29401177439526	1.29395272483047	1.29389367526569	1.29383992272479	1.29383998022962	1.29379249009919	1.29377232976850	1.29383443808802	1.29391272740073	1.29399101671597	1.29407952351877	1.29422710342088	1.29441580680311	1.29461915527418	1.29513865034079	1.29565049697755	1.29616234361431	1.29667419025179	1.29718603688920	1.29771479191983	1.29827997805176	1.29902512337962	1.29982434755012	1.30085811030890	1.30189187306711	1.30292563582589	1.30395939858588	1.30511621650136	1.30635007444366	1.30756933364221	1.30878859284521	1.31003360979046	1.31158905025535	1.31316949333564	1.31478962773308	1.31647223359798	1.31819475758241	1.31994364823511	1.32169253888985	1.32339865955444	1.32503153435367	1.32686216371938	1.32871544189071	1.33056872006110	1.33242199823148	1.33434627000021	1.33652065247060	1.33867482952675	1.34081883394094	1.34298972933562	1.34536092343082	1.34763380292284	1.34979897621907	1.35196414951685	1.35415091170264	1.35635715719054	1.35856340267682	1.36067862303326	1.36265500830797	1.36485275191472	1.36705049552235	1.36924823913072	1.37144598273929	1.37367013996313	1.37575440335169	1.37759353040225	1.37942316495765	1.38123657283175	1.38295719080852	1.38467780878274	1.38639842675580	1.38811904473168	1.38963736746530	1.39107889017473	1.39253995775810	1.39400613962964	1.39547407073737	1.39695109716669	1.39842812358960	1.39990515001241	1.40132681902228	1.40195048849203	1.40259178675831	1.40324894653798	1.40391191797387	1.40454589587165	1.40504619896259	1.40554650205347	1.40604680515402	1.40644258204839	1.40585784914213	1.40529712414018	1.40476165967683	1.40423586702495	1.40368467554508	1.40303763203565	1.40242295564372	1.40180827924442	1.40113306865477	1.39998833436859	1.39887993089535	1.39778608676616	1.39669254101889	1.39553243341788	1.39411599628208	1.39269955913565	1.39130006645568	1.38981761496407	1.38760309375516	1.38540332029572	1.38319207640138	1.38098505508135	1.37877653940157	1.37636736809516	1.37395819679496	1.37159787340111	1.36919897623664	1.36629276215697	1.36341652614706	1.36054029010136	1.35766534300831	1.35474959567085	1.35164577773552	1.34858485809749	1.34566455373988	1.34252208123114	1.33839814896854	1.33428865201760	1.33018376334294	1.32621798252749	1.32227860006806	1.31807495294848	1.31383514964468	1.30936800732480	1.30495772884105	1.30049095274807	1.29594207854365	1.29149500491635	1.28705266173446	1.28227588470957	1.27657025625973	1.27087867854476	1.26521533793456	1.25953409977751	1.25384057397886	1.24775118167399	1.24164039903018	1.23636414045332	1.23024562821136	1.22417777080970	1.21861517708199	1.21334633403840	1.20837678919731	1.20323734591942	1.19790576226317	1.19266941156613	1.18684706231875	1.18129790408096	1.17589923386300	1.16985590915340	1.16402464902847	1.15796871689692	1.15156564192136	1.14422863911275	1.13658093482661	1.12870571458428	1.12032546293713	1.11114732403001	1.10195933844810	1.09261260771863	1.08287073989768	1.07310482816891	1.06395287048613	1.05451580083070	1.04433553517657	1.03593984790234	1.02639724472492	1.01642873997249	1.00802815705694	0.998727534537297	0.990310155998112	0.982056707575063	0.973329653389692	0.965136916823266	0.956688728366506	0.948236201576111	0.939857563808352	0.931950823821321	0.924498721504675	0.917095095687720	0.909715012777543	0.902241865654644	0.894750418995299	0.887389993161348	0.880079937498440	0.872913528098015	0.865667127629139	0.858420727160262	0.851212534931408	0.844859286800932	0.838518084256402	0.832190133824789	0.825910553879568	0.819358827845310	0.813161376081043	0.807269855658407	0.801378335235585	0.795446638238649	0.789513208806259	0.783606872463514	0.777781135412431	0.772341503817141	0.767261011219960	0.762831081598613	0.758401151977265	0.753733164805513	0.749660666364126	0.745639363781855	0.741618061199583	0.738109145259032	0.735054894188910	0.732019469220364	0.728982788156513	0.726025717830133	0.723161102717844	0.719995016080316	0.718445137514976	0.717126337161819	0.715528789789592	0.713577285031891	0.711231578754647	0.708886121869227	0.706622864901699	0.704826915655077	0.705410243754358	0.706004227778640	0.706509669764216	0.706520720800137	0.706610051098474	0.706705296234177	0.707629572339888	0.709203512602492	0.711210064900132	0.714563593797656	0.718723884690858	0.722065041410210	0.724810201561873	0.727496954510913	0.730278505264543	0.733011944782669	0.735750865084881	0.741484059754642	0.747536758935150	0.751440570778826	0.754979370269426	0.759002393639822	0.764943560196472	0.770837743918457	0.776907350996768	0.783037242888988	0.789855648717983	0.798899575327516	0.807171846233853	0.814924338274823	0.823068460479261	0.830552977788160	0.836702893209310	0.842877874670984	0.859459231689903	0.867544362389447	0.873810219942734	0.882270464335343	0.893051676222079	0.903349770353856	0.913042911113713	0.922429214714037	0.931480602736511	0.940907356888433	0.952208566781032	0.964793033498987	0.979396636567456	0.992575071908906	1.00536288412504	1.01709675044943	1.02965762439011	1.04315558959087	1.06046358918018	1.07527855991583	1.08777248119390	1.10633835521004	1.12473295481534	1.13972713635889	1.15643253445816	1.17443866427617	1.19305178639234	1.20701417797022	1.21930197761178	1.23705161935488	1.25730252866669	1.27219548174031	1.28558955775071	1.29792704663761	1.31001786378919	1.32195136944195	1.34331695784489	1.34588882871531	1.34840076056332	1.34904738464737	1.34969400873142	1.34884653231533	1.34094876916131	1.33305100600730	1.32273866972257	1.31239965307176	1.28721575299405	1.26558163927093	1.23688073198099	1.20537674228940	1.18522809548940	1.15711035491408	1.10990468227644	1.08228686424917	1.04478874962093	1.01311274468558	0.974659512379683	0.929676562785505	0.904931905430070	0.853431328596570	0.809668186296931	0.775604630848351	0.731817585281782	0.697164308947947	0.664180932550060	0.631726577361340	0.592332264183302	0.557508723329435	0.536783863915953	0.503351073476483	0.475614400848163	0.452394806753040	0.431136105337293	0.407617738641971	0.383858585190662	0.364854784585365	0.339255867096242	0.322729372817383	0.309432797087400	0.296136221357418	0.277876767535502	0.259710116161115	0.244162239151594	0.231774855967817	0.222463480508818	0.213153546409165	0.203619189108685	0.193561701267792	0.183504213426899	0.174487264714140	0.167202328275232	0.159996101832686	0.152841670280438	0.147363309383111	0.142638269505046	0.137913229626942	0.133188189748837	0.128463149870733	0.123738109992628	0.118910290105720	0.114542506905312	0.111085003467700	0.107627500030088	0.104169996592476	0.100712493154864	0.0972549897172520	0.0937974862796401	0.0903399828420281	0.0868824794044273	0.0842363332825081	0.0820429489126847	0.0800677641730848	0.0780925794334660	0.0761173946938471	0.0741422099542283	0.0721670252146094	0.0701918404749906	0.0682166557353718	0.0666251498556604	0.0651977139851960	0.0637702781147315	0.0623428422443655	0.0607856840328361	0.0592244561009274	0.0576632281690217	0.0561020002371161	0.0545407723052104	0.0533312624401880	0.0522825925592901	0.0512339226783921	0.0501852527974942	0.0491365829165855	0.0480879130356042	0.0470392431546229	0.0320259045446041	3.28206086658648e-11	3.23860104736726e-11	3.19017374031433e-11	3.12595162658250e-11	3.06172951285066e-11	2.99750739911883e-11	2.93328528538699e-11	2.87290771515520e-11	2.81372588985009e-11	2.75454406454498e-11	2.69536223923987e-11	2.63618041393475e-11	2.57699858862964e-11	2.51781676332453e-11	2.47267998909927e-11	2.43161772199056e-11	2.39055545488185e-11	2.35299417187821e-11	2.32075293220721e-11	2.28851169253620e-11	2.25627045286520e-11	2.22402921319420e-11	2.19178797352319e-11	2.15954673385219e-11	2.12730549418119e-11	2.09506425451018e-11	2.04717390438448e-11	1.98296861896942e-11	1.91121505821657e-11	1.83946149746373e-11	1.76770793671088e-11	1.69595437595804e-11	1.62420081520519e-11	1.55244725445235e-11	1.48069369369950e-11	1.40894013294666e-11	1.33718657219381e-11	3.74590893634916e-13	0	0	0	0	0];
x_curve_init = [0.000130000000000000	0.00136800000000000	0.0143100000000000	0.134380000000000	0.348280000000000	0.290800000000000	0.0956400000000000	0.00490000000000000	0.0632700000000000	0.290400000000000	0.594500000000000	0.916300000000000	1.06220000000000	0.854450000000000	0.447900000000000	0.164900000000000	0.0467700000000000	0.0113590000000000	0.00289900000000000	0.000690000000000000	0.000166000000000000	4.20000000000000e-05	1.00000000000000e-05	3.00000000000000e-06];
y_curve_init = [4.00000000000000e-06	3.90000000000000e-05	0.000396000000000000	0.00400000000000000	0.0230000000000000	0.0600000000000000	0.139020000000000	0.323000000000000	0.710000000000000	0.954000000000000	0.995000000000000	0.870000000000000	0.631000000000000	0.381000000000000	0.175000000000000	0.0610000000000000	0.0170000000000000	0.00410200000000000	0.00104700000000000	0.000249000000000000	6.00000000000000e-05	1.50000000000000e-05	4.00000000000000e-06	1.00000000000000e-06];
z_curve_init = [0.000606000000000000	0.00645000000000000	0.0678500000000000	0.645600000000000	1.74706000000000	1.66920000000000	0.812950000000000	0.272000000000000	0.0782500000000000	0.0203000000000000	0.00390000000000000	0.00165000000000000	0.000800000000000000	0.000190000000000000	2.00000000000000e-05	0	0	0	0	0	0	0	0	0];
% x_curve = interp1(Lambda_init, x_curve_init, Lambda, 'pchip', 0);
% y_curve = interp1(Lambda_init, y_curve_init, Lambda, 'pchip', 0);
% z_curve = interp1(Lambda_init, z_curve_init, Lambda, 'pchip', 0);
[x_curve, y_curve, z_curve] = ra.cie_xyz(Lambda);


%% XYZ
kc = 100/trapz(Lambda, I.*y_curve);
X = kc * trapz(Lambda, I.*x_curve);
Y = kc * trapz(Lambda, I.*y_curve);
Z = kc * trapz(Lambda, I.*z_curve);
x = X/(X+Y+Z);
y = Y/(X+Y+Z);

%% Lu'v'
Luv = Y;
u = 4*X/(X+15*Y+3*Z);
v = 9*Y/(X+15*Y+3*Z);

%% L*a*b*
X_D50 = 96.422;
Y_D50 = 100;
Z_D50 = 82.521;
if (X/X_D50) > 0.00885645
    fx = (X/X_D50)^(1/3);
else
    fx = (903.3*X/X_D50+16)/116;
end
if (Y/Y_D50) > 0.00885645
    fy = (Y/Y_D50)^(1/3);
else
    fy = (903.3*Y/Y_D50+16)/116;
end
if (Z/Z_D50) > 0.00885645
    fz = (Z/Z_D50)^(1/3);
else
    fz = (903.3*Z/Z_D50+16)/116;
end
Lab = 116*fy-16;
a = 500*(fx-fy);
b = 200*(fy-fz);

%% КТЦ
c = 3e8;
h = 6.6262e-34;
k = 1.38067e-23;
LL = Lambda*1e-9;
M = 2*h*c^2./(LL.^5.*(exp(h*c./(LL*k*6000))-1));

Tc = [0	10	20	30	40	50	60	70	80	90	100	125	150	175	200	225	250	275	300	325	350	375	400	425	450	475	500	525	550	575	600];
ux0 = [0.180060000000000	0.180660000000000	0.181330000000000	0.182080000000000	0.182930000000000	0.183880000000000	0.184940000000000	0.186110000000000	0.187400000000000	0.188800000000000	0.190320000000000	0.194620000000000	0.199620000000000	0.205250000000000	0.211420000000000	0.218070000000000	0.225110000000000	0.232470000000000	0.240100000000000	0.247920000000000	0.255910000000000	0.264000000000000	0.272180000000000	0.280390000000000	0.288630000000000	0.296850000000000	0.305050000000000	0.313200000000000	0.321290000000000	0.329310000000000	0.337240000000000];
vx0 = [0.263520000000000	0.265890000000000	0.268460000000000	0.271190000000000	0.274070000000000	0.277090000000000	0.280210000000000	0.283420000000000	0.286680000000000	0.289970000000000	0.293260000000000	0.301410000000000	0.309210000000000	0.316470000000000	0.323120000000000	0.329090000000000	0.334390000000000	0.339040000000000	0.343080000000000	0.346550000000000	0.349510000000000	0.352000000000000	0.354070000000000	0.355770000000000	0.357140000000000	0.358230000000000	0.359070000000000	0.359680000000000	0.360110000000000	0.360380000000000	0.360510000000000];
t = [-0.243410000000000	-0.254790000000000	-0.268760000000000	-0.285390000000000	-0.304700000000000	-0.326750000000000	-0.351560000000000	-0.379150000000000	-0.409550000000000	-0.442780000000000	-0.478880000000000	-0.582040000000000	-0.704710000000000	-0.849010000000000	-1.01820000000000	-1.21680000000000	-1.45120000000000	-1.72980000000000	-2.06370000000000	-2.46810000000000	-2.96410000000000	-3.58140000000000	-4.36330000000000	-5.37620000000000	-6.72620000000000	-8.59550000000000	-11.3240000000000	-15.6280000000000	-23.3250000000000	-40.7700000000000	-116.450000000000];
ux = 4*X/(X+15*Y+3*Z); % u в специализированном цветовом простраснтве u' с точкой
vx = 6*Y/(X+15*Y+3*Z); % v в специализированном цветовом простраснтве v' с точкой

d = ((vx-vx0) - t.*(ux-ux0))./sqrt(1+t.^2);
pos_val = find(d > 0);
[d1, d1_idx] = min(d(pos_val));
d2_idx = d1_idx + 1;
d2 = d(d2_idx);
Tc1 = Tc(d1_idx);
Tc2 = Tc(d2_idx);
Txc = Tc1 + d1 * (Tc2-Tc1)/(d1-d2); %Тц в миревах (u)
TxcK = 1e6/Txc; % Тц в К

%% Ra около кривой планка с цветовым различием не более 0,01
plank = 2*h*c^2./(LL.^5.*(exp(h*c./(LL*k*7000))-1)); % эталонный источник
kc_ref = 100/trapz(LL, plank.*y_curve);
Xref = kc_ref * trapz(LL, plank.*x_curve);
Yref = kc_ref * trapz(LL, plank.*y_curve);
Zref = kc_ref * trapz(LL, plank.*z_curve);

Luv_ref = Yref;
u_ref = 4*Xref/(Xref+15*Yref+3*Zref);
v_ref = 9*Yref/(Xref+15*Yref+3*Zref);

R = ra.rObjects(Lambda);
R = R';

XRtest = zeros(1,14); YRtest = zeros(1,14); ZRtest = zeros(1,14);
LRtest = zeros(1,14); uRtest = zeros(1,14); vRtest = zeros(1,14);
LxRtest = zeros(1,14); uxRtest = zeros(1,14); vxRtest = zeros(1,14);

XRref = zeros(1,14); YRref = zeros(1,14); ZRref = zeros(1,14);
LRref = zeros(1,14); uRref = zeros(1,14); vRref = zeros(1,14);
LxRref = zeros(1,14); uxRref = zeros(1,14); vxRref = zeros(1,14);
dE = zeros(1, 14); CRI = zeros(1, 14);
for i=1:14
    % координаты цвета эталонных поврехностей, освещаемых исследуемым
    % (тестируемым) источником
    XRtest(1,i) = kc*trapz(Lambda, I.*R(i,:).*x_curve);
    YRtest(1,i) = kc*trapz(Lambda, I.*R(i,:).*y_curve);
    ZRtest(1,i) = kc*trapz(Lambda, I.*R(i,:).*z_curve);
    LRtest(1, i) = YRtest(1,i);
    uRtest(1, i) = 4*XRtest(1,i)/(XRtest(1,i)+15*YRtest(1,i)+3*ZRtest(1,i));
    vRtest(1, i) = 9*YRtest(1,i)/(XRtest(1,i)+15*YRtest(1,i)+3*ZRtest(1,i));
    LxRtest(1, i) = 116*(YRtest(1,i)/Y).^(1/3) - 16;
    uxRtest(1, i) = 13*LxRtest(1, i)*(uRtest(1, i)-u);
    vxRtest(1, i) = 13*LxRtest(1, i)*(vRtest(1, i)-v);

    % координаты цвета эталонных поврехностей, освещаемых эталонным
    % (референсным) источником
    XRref(1,i) = kc_ref*trapz(LL, plank.*R(i,:).*x_curve);
    YRref(1,i) = kc_ref*trapz(LL, plank.*R(i,:).*y_curve);
    ZRref(1,i) = kc_ref*trapz(LL, plank.*R(i,:).*z_curve);
    LRref(1, i) = YRref(1,i);
    uRref(1, i) = 4*XRref(1,i)/(XRref(1,i)+15*YRref(1,i)+3*ZRref(1,i));
    vRref(1, i) = 9*YRref(1,i)/(XRref(1,i)+15*YRref(1,i)+3*ZRref(1,i));
    LxRref(1, i) = 116*(YRref(1,i)/Y).^(1/3) - 16;
    uxRref(1, i) = 13*LxRref(1, i)*(uRref(1, i)-u);
    vxRref(1, i) = 13*LxRref(1, i)*(vRref(1, i)-v);
    
    % Цветовая разность
    dE(1, i) = sqrt(...
        (LxRtest(1, i)-LxRref(1, i))^2 + ...
        (uxRtest(1, i)-uxRref(1, i))^2 + ...
        (vxRtest(1, i)-vxRref(1, i))^2 ...
        );
    
    % Частные индексы цветопередачи
    CRI(1, i) = 100 - 4.6*dE(1, i);
end
    CRIo = mean(CRI);

%% Ra около кривой планка с цветовым различием более 0,01
plank2 = 2*h*c^2./(LL.^5.*(exp(h*c./(LL*k*TxcK))-1)); % эталонный источник
kc_ref2 = 100/trapz(LL, plank2.*y_curve);
Xref2 = kc_ref2 * trapz(LL, plank2.*x_curve);
Yref2 = kc_ref2 * trapz(LL, plank2.*y_curve);
Zref2 = kc_ref2 * trapz(LL, plank2.*z_curve);

Luv_ref2 = Yref2;
u_ref2 = 4*Xref2/(Xref2+15*Yref2+3*Zref2);
v_ref2 = 9*Yref2/(Xref2+15*Yref2+3*Zref2);

XRref2 = zeros(1,14); YRref2 = zeros(1,14); ZRref2 = zeros(1,14);
LRref2 = zeros(1,14); uRref2 = zeros(1,14); vRref2 = zeros(1,14);
LXRref2 = zeros(1,14); uXRref2 = zeros(1,14); vXRref2 = zeros(1,14);

rref2 = (4 - u_ref2 - 10 * v_ref2)/v_ref2;
fref2 = (1.708*v_ref2 + 0.404 - 1.481*u_ref2)/v_ref2;
rtest2 = (4 - u - 10 * v)/v;
ftest2 = (1.708*v + 0.404 - 1.481*u)/v;
rR2 = zeros(1,14); fR2 = zeros(1,14);
uxxRtest = zeros(1,14); vxxRtest = zeros(1,14);
LxxxRref = zeros(1,14); uxxxRref = zeros(1,14); vxxxRref = zeros(1,14);
LxxxRtest = zeros(1,14); uxxxRtest = zeros(1,14); vxxxRtest = zeros(1,14);
dE2 = zeros(1, 14); CRI2 = zeros(1, 14);
for i=1:14
    % координаты цвета эталонных поврехностей, освещаемых эталонным
    % (референсным) источником
    XRref2(1,i) = kc_ref2*trapz(LL, plank2.*R(i,:).*x_curve);
    YRref2(1,i) = kc_ref2*trapz(LL, plank2.*R(i,:).*y_curve);
    ZRref2(1,i) = kc_ref2*trapz(LL, plank2.*R(i,:).*z_curve);
    LRref2(1, i) = YRref2(1,i);
    uRref2(1, i) = 4*XRref2(1,i)/(XRref2(1,i)+15*YRref2(1,i)+3*ZRref2(1,i));
    vRref2(1, i) = 9*YRref2(1,i)/(XRref2(1,i)+15*YRref2(1,i)+3*ZRref2(1,i));
    LXRref2(1, i) = 116*(YRref2(1,i)/Y).^(1/3) - 16;
    uXRref2(1, i) = 13*LXRref2(1, i)*(uRref2(1, i)-u);
    vXRref2(1, i) = 13*LXRref2(1, i)*(vRref2(1, i)-v);

    rR2(1, i) = (4 - uRtest(1, i) - 10 * vRtest(1, i))/vRtest(1, i);
    fR2(1, i) = (1.708*vRtest(1, i) + 0.404 - 1.481*uRtest(1, i))/vRtest(1, i);

    uxxRtest(1, i) = (10.872+0.404*(rref2/rtest2)*rR2(1, i) - 4*(fref2/ftest2)*fR2(1, i))/(16.518+1.481*(rref2/rtest2)*rR2(1, i)-(fref2/ftest2)*fR2(1, i));
    vxxRtest(1, i) = 5.520/(16.518+1.481*(rref2/rtest2)*rR2(1, i)-(fref2/ftest2)*fR2(1, i));

    
    uxxtest = (10.872+0.404*rref2 - 4*fref2)/(16.518+1.481*rref2-fref2);
    vxxtest = 5.520/(16.518+1.481*rref2-fref2);

    LxxxRref(1, i) = (116*(YRref2(1,i)/Yref2)^(1/3)-16);
    uxxxRref(1, i) = 13*LxxxRref(1, i)*(uRref2(1, i)-u_ref2);
    vxxxRref(1, i) = 13*LxxxRref(1, i)*(vRref2(1, i)-v_ref2);

    LxxxRtest(1, i) = (116*(YRtest(1,i)/Y)^(1/3)-16);
    uxxxRtest(1, i) = 13*LxxxRtest(1, i)*(uxxRtest(1, i)-uxxtest);
    vxxxRtest(1, i) = 13*LxxxRtest(1, i)*(vxxRtest(1, i)-vxxtest);

% Цветовая разность
    dE2(1, i) = sqrt(...
        (LxxxRref(1, i)-LxxxRtest(1, i))^2 + ...
        (uxxxRref(1, i)-uxxxRtest(1, i))^2 + ...
        (vxxxRref(1, i)-vxxxRtest(1, i))^2 ...
        );
    
    % Частные индексы цветопередачи
    CRI2(1, i) = 100 - 4.6*dE2(1, i);
end
CRIo2 = mean(CRI2);

%% Вывод
fprintf('xy = (%.4f, %.4f), u''v'' = (%.4f, %.4f), a*b* = (%.4f, %.4f)\n', x, y, u, v, a, b);
fprintf('КТЦ = %.4f\n', TxcK);
fprintf('Ra near plank = %.4f, Ra not near plank = %.4f\n', CRIo, CRIo2);

